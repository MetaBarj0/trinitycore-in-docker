include:
  - docker.d/servers_and_tools_builder/docker-compose.yaml
version: '3'
services:
  databases:
    build:
      context: ./docker.d/databases
      dockerfile: databases.Dockerfile
      tags:
        - ${NAMESPACE}.trinitycore.databases:${DATABASES_VERSION}
    entrypoint: /root/scripts/databases-entrypoint.sh
    healthcheck:
      test: ['CMD-SHELL', '/root/scripts/healthcheck.sh']
      interval: 1s
      timeout: 10s
      retries: 10
      start_period: 2s
      start_interval: 1s
    init: true
    networks:
      inside:
        ipv4_address: 11.12.13.1
    volumes:
      - type: volume
        source: databases_data
        target: /var/lib/mysql/data
      - type: volume
        source: trinitycore_sources
        target: /root/TrinityCore
  worldserver:
    depends_on:
      databases:
        condition: service_healthy
    entrypoint: /home/trinitycore/scripts/worldserver-entrypoint.sh
    image: ${NAMESPACE}.trinitycore.worldserver:${WORLDSERVER_VERSION}
    init: true
    networks:
      inside:
        ipv4_address: 11.12.13.2
    volumes:
      - type: volume
        source: worldserver_downloads
        target: /home/trinitycore/downloads
      - type: volume
        source: client_data
        target: /home/trinitycore/trinitycore/data
        read_only: true
      - type: volume
        source: trinitycore_sources
        target: /home/trinitycore/TrinityCore
  worldserver_console:
    build:
      context: ./docker.d/worldserver_console
      dockerfile: worldserver_console.Dockerfile
      tags:
        - ${NAMESPACE}.trinitycore.worldserver_console:${WORLDSERVER_CONSOLE_VERSION}
    depends_on:
      - worldserver
    entrypoint: /home/worldserver_console/scripts/worldserver_console-entrypoint.sh
    environment:
      - ADMIN_ACCOUNT_NAME=${ADMIN_ACCOUNT_NAME}
      - ADMIN_ACCOUNT_PASSWORD=${ADMIN_ACCOUNT_PASSWORD}
    healthcheck:
      test: ['CMD-SHELL', '/home/worldserver_console/scripts/healthcheck.sh']
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 20s
      start_interval: 10s
    init: true
    networks:
      inside:
        ipv4_address: 11.12.13.3
  # authserver:
  #   depends_on:
  #   - worldserver
  #   entrypoint: /home/docker/authserver-entrypoint.sh
  #   image: ${NAMESPACE}.trinitycore.authserver:${AUTHSERVER_VERSION}
  #   init: true
volumes:
  databases_data:
  worldserver_downloads:
networks:
  inside:
    ipam:
      driver: default
      config:
        - subnet: 11.12.13.0/29
          ip_range: 11.12.13.0/29
          gateway: 11.12.13.6
